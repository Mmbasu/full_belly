{% extends "users/registration_base.html" %}

{% block title %}Login{% endblock %}

{% block content %}

<!--<section class="py-36">-->
<!--  <div class="container px-4 mx-auto">-->
<!--    <div class="relative max-w-lg mx-auto pt-16 pb-16 px-6 md:px-10 lg:px-16 rounded-xl" style="background-color: #ffffff; rounded-xl">-->
<!--      <a class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2" href="#">-->
<!--        <img class="block" src="https://i.ibb.co/wKwTF3T/Screenshot-from-2023-03-18-08-54-04.png" alt="Screenshot-from-2023-03-18-08-54-04" width="130" style="border: 2px solid #ADD8E6; border-radius: 0.5rem;">-->
<!--      </a>-->
<!--      <div class="relative max-w-md mx-auto text-center">-->
<!--        <h2 class="text-2xl text-dark font-semibold mb-2">Log in to your account</h2>-->
<!--        <p class="text-gray-500 font-medium mb-10">Welcome back! Please enter your details.</p>-->
<!--        <form id="login-form" method="post" action="{% url 'users:login' %}">-->
<!--          {% csrf_token %}-->
<!--          {% for field in form %}-->
<!--            {% if field.name == 'email' %}-->
<!--              <div class="relative w-full h-14 py-4 px-3 mb-8 border border-gray-400 hover:border-white focus-within:border-green-500 rounded-lg {% if field.errors %}is-invalid{% endif %}">-->
<!--                <span class="absolute bottom-full left-0 ml-3 -mb-1 transform translate-y-0.5 text-xs font-semibold text-white px-1 rounded-lg" style="background-color: #183F4A;">{{ field.label }}</span>-->
<!--                <input class="block w-full bg-transparent text-sm text-dark font-medium outline-none rounded-lg" type="email" placeholder="{{ field.label }}" name="{{ field.name }}">-->
<!--              </div>-->
<!--            {% endif %}-->
<!--          {% endfor %}-->
<!--          {% for field in form %}-->
<!--            {% if field.name == 'password' %}-->
<!--              <div class="relative w-full h-14 py-4 px-3 mb-8 border border-gray-400 hover:border-white focus-within:border-green-500 rounded-lg {% if field.errors %}is-invalid{% endif %}">-->
<!--                <span class="absolute bottom-full left-0 ml-3 -mb-1 transform translate-y-0.5 text-xs font-semibold text-white px-1 rounded-lg" style="background-color: #183F4A;">{{ field.label }}</span>-->
<!--                <div class="flex items-center">-->
<!--                <input class="block w-full bg-transparent text-sm text-dark font-medium outline-none rounded-lg" type="password" placeholder="{{ field.label }}" name="{{ field.name }}">-->
<!--                  <button class="btn btn-outline-secondary toggle-password ml-2" type="button">-->
<!--                    <i class="fa-solid fa-eye-slash"></i>-->
<!--                  </button>-->
<!--                </div>-->
<!--              </div>-->
<!--            {% endif %}-->
<!--          {% endfor %}-->
<!--          <div class="flex flex-wrap items-center justify-between mb-6">-->
<!--            <div class="w-full sm:w-auto"><a class="inline-block text-xs font-semibold" style="color: #237473;" href="{% url 'users:forgot_password' %}">Forgot password?</a></div>-->
<!--          </div>-->
<!--          <button class="block w-full py-4 mb-4 leading-6 text-white font-semibold" style="background-color: #237473; color: #fff; border-radius: 0.5rem; transition: background-color 200ms;">Sign In</button>-->
<!--          <p class="font-medium">-->
<!--            <span class="text-gray-500">Don’t have an account?</span>-->
<!--            <a class="inline-block hover:underline" style="color: #237473" href="{% url 'users:register' %}">Sign up</a>-->
<!--          </p>-->
<!--        </form>-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->
<!--</section>-->


<section class="py-36">
  <div class="container px-4 mx-auto">
    <div class="relative max-w-lg mx-auto pt-16 pb-16 px-6 md:px-10 lg:px-16 rounded-xl border-2" style="background-color: #ffffff; border-color: #2BA19A;">
      <a class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2">
        <img class="block" src="https://i.ibb.co/wKwTF3T/Screenshot-from-2023-03-18-08-54-04.png" alt="Screenshot-from-2023-03-18-08-54-04" width="130" style="border: 2px solid #ADD8E6; border-radius: 0.5rem;">
      </a>
      <div class="relative max-w-md mx-auto text-center">
      <h2 class="text-4xl text-dark font-semibold mb-2 mt-4">SignIn</h2>
      <p class="text-gray-500 font-medium mb-6 mt-4">Welcome back! Please enter your details.</p>

      <form id="login-form" method="post" action="{% url 'users:login' %}">
        {% csrf_token %}
        {% for field in form %}
          {% if field.name == 'username' %}
        <div class="relative w-full h-14 py-4 px-3 mb-6 border-gray-400 focus-within:border-green-500 rounded-lg {% if field.errors %}is-invalid{% endif %}">
          <input class="block w-full h-14 bg-transparent text-sm text-dark font-medium rounded-lg" type="text" name="{{ field.name }}" placeholder="{{ field.label }}">
              {% if field.errors %}
                <div class="invalid-feedback">
                  {% for error in field.errors %}
                  <p style="color: red !important;">{{ error }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
        {% for field in form %}
          {% if field.name == 'password' %}
        <div class="relative w-full h-14 py-4 px-3 mb-6 border-gray-400 focus-within:border-green-500 rounded-lg {% if field.errors %}is-invalid{% endif %}">
              <div class="flex items-center mb-4">
                <input class="block w-full h-14 bg-transparent text-sm text-dark font-medium rounded-lg" type="password" name="{{ field.name }}" placeholder="{{ field.label }}">
                <button class="btn btn-outline-danger ml-4 toggle-password" type="button">
                  <i class="fa-solid fa-eye-slash"></i>
                </button>
              </div>
              {% if field.errors %}
              <div class="invalid-feedback my-2" style="margin-bottom: 0.5rem;">
                {% for error in field.errors %}
                  <p><span style="color: red !important;">{{ error }}</span></p>
                {% endfor %}
              </div>

              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
        <div class="flex flex-wrap items-center justify-between mb-6">
          <div class="w-full sm:w-auto"><a class="inline-block text-lg" style="color: #AF8905;" href="{% url 'users:forgot_password' %}">Forgot password?</a></div>
        </div>
        <button type="submit" id="login_button" class="group relative font-medium leading-6 px-6 mb-4 py-5 w-full uppercase text-white text-xs font-semibold tracking-px bg-custom-color hover:bg-custom-hover overflow-hidden rounded-md">
              <div class="absolute top-0 left-0 transform -translate-x-full group-hover:-translate-x-0 h-full w-full transition ease-in-out duration-500 bg-gradient-custom"></div>
              <p class="relative z-10">Sign In</p>
            </button>
        <p class="font-medium">
          <span class="text-gray-500">Don’t have an account?</span>
          <a class="inline-block hover:underline" style="color: #AF8905" href="{% url 'users:register' %}">Sign up</a>
        </p>
      </form>

      </div>
    </div>

  </div>
</section>

<script>

const togglePasswordButtons = document.querySelectorAll('.toggle-password');
togglePasswordButtons.forEach(button => {
  button.addEventListener('click', () => {
    const passwordInput = button.previousElementSibling;
    const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
    passwordInput.setAttribute('type', type);
    button.innerHTML = type === 'password' ? '<i class="fas fa-eye-slash"></i>' : '<i class="fas fa-eye"></i>';
  });
});

    window.history.pushState(null, "", window.location.href);
    window.onpopstate = function () {
        window.history.pushState(null, "", window.location.href);
    };
</script>


<!--<script>-->
<!--  $(document).ready(function() {-->

<!--    $('#login-form').submit(function(event) {-->
<!--      event.preventDefault();-->
<!--      var formData = new FormData(this);-->
<!--      var jsonFormData = {};-->
<!--      for (var [key, value] of formData.entries()) {-->
<!--        jsonFormData[key] = value;-->
<!--      }-->
<!--      axios.post("{% url 'users:login' %}", JSON.stringify(jsonFormData), {-->
<!--        headers: {-->
<!--          'Content-Type': 'application/json',-->
<!--          'X-CSRFToken': '{{ csrf_token }}'-->
<!--        }-->
<!--      })-->
<!--        .then(function(response) {-->
<!--          if (response.data.success) {-->
<!--            window.location.href= "{% url 'donor:dashboard' %}"; // replace 'home' with your desired redirect URL-->
<!--          } else {-->
<!--            // Clear any existing error messages-->
<!--            $('.invalid-feedback').remove();-->

<!--            // Add error message to form fields with errors-->
<!--            for (const field in response.data.errors) {-->
<!--              if (field === '__all__') {-->
<!--                $('#login-form').prepend('<div class="invalid-feedback text-red-600 mb-2">' + response.data.errors[field] + '</div>');-->
<!--              } else {-->
<!--                var errorField = $('#id_' + field);-->
<!--                errorField.addClass('border-red-600');-->
<!--                errorField.parent().append('<div class="invalid-feedback text-red-600">' + response.data.errors[field][0] + '</div>');-->
<!--              }-->
<!--            }-->
<!--          }-->
<!--        })-->
<!--        .catch(function(error) {-->
<!--          console.error(error);-->
<!--        });-->
<!--    });-->
<!--  });-->
<!--</script>-->



<!--<script>-->
<!--  $(document).ready(function() {-->

<!--    $('#login-form').submit(function(event) {-->
<!--      event.preventDefault();-->
<!--      var formData = new FormData(this);-->
<!--      var jsonFormData = {};-->
<!--      for (var [key, value] of formData.entries()) {-->
<!--        jsonFormData[key] = value;-->
<!--      }-->

<!--      // Show processing modal-->
<!--      var processingModal = createModal('Processing', 'Logging You in...');-->
<!--      $('body').append(processingModal);-->

<!--      // Clear any existing error messages when the login button is pressed-->
<!--      clearErrorMessages();-->

<!--      axios.post("{% url 'users:login' %}", JSON.stringify(jsonFormData), {-->
<!--        headers: {-->
<!--          'Content-Type': 'application/json',-->
<!--          'X-CSRFToken': '{{ csrf_token }}'-->
<!--        }-->
<!--      })-->
<!--        .then(function(response) {-->
<!--          // Remove processing modal-->
<!--          $(processingModal).remove();-->

<!--          if (response.data.success) {-->
<!--            window.location.href = response.data.redirect_url;-->
<!--          } else {-->
<!--            // Clear any existing error messages-->
<!--            clearErrorMessages();-->

<!--            // Add error message to form fields with errors-->
<!--            for (const field in response.data.errors) {-->
<!--              if (field === '__all__') {-->
<!--                $('#login-form').prepend('<div class="invalid-feedback text-red-600 mb-2">' + response.data.errors[field] + '</div>');-->
<!--              } else {-->
<!--                var errorField = $('#id_' + field);-->
<!--                errorField.addClass('border-red-600');-->
<!--                errorField.parent().append('<div class="invalid-feedback text-red-600">' + response.data.errors[field][0] + '</div>');-->
<!--              }-->
<!--            }-->
<!--          }-->
<!--        })-->
<!--        .catch(function(error) {-->
<!--          console.error(error);-->
<!--          $(processingModal).remove(); // Remove processing modal on error-->
<!--        });-->
<!--    });-->

<!--    // Function to create a modal with the given heading and message-->
<!--    function createModal(heading, message) {-->
<!--      var modal = document.createElement('div');-->
<!--      modal.classList.add('modal', 'fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-gray-800', 'bg-opacity-50', 'z-50');-->
<!--      modal.innerHTML = `-->
<!--        <div class="modal-content modal-large">-->
<!--          <div><i class="fa-solid fa-circle-check fa-beat-fade fa-2xl" style="margin-top: 20px; margin-bottom: 30px; color: #2BA19A;"></i></div>-->
<!--          <h2 class="mb-2 text-2xl lg:text-2xl font-bold font-heading" style="color: #2BA19A;">${heading}</h2>-->
<!--          <p>${message}</p>-->
<!--        </div>-->
<!--      `;-->
<!--      return modal;-->
<!--    }-->

<!--    // Function to clear error messages-->
<!--    function clearErrorMessages() {-->
<!--      $('.invalid-feedback').remove();-->
<!--    }-->

<!--    // Add event listener to the login button to clear errors-->
<!--    $('#login_button').click(function() {-->
<!--      clearErrorMessages();-->
<!--    });-->
<!--  });-->
<!--</script>-->

<script>
  $(document).ready(function() {
    // Function to create a modal with the given heading and message
    function createModal(heading, message) {
      var modal = document.createElement('div');
      modal.classList.add('modal', 'fixed', 'inset-0', 'flex', 'items-center', 'justify-center', 'bg-gray-800', 'bg-opacity-50', 'z-50');
      modal.innerHTML = `
        <div class="modal-content modal-large">
          <div><i class="fa-solid fa-circle-check fa-beat-fade fa-2xl" style="margin-top: 20px; margin-bottom: 30px; color: #2BA19A;"></i></div>
          <h2 class="mb-2 text-2xl lg:text-2xl font-bold font-heading" style="color: #2BA19A;">${heading}</h2>
          <p>${message}</p>
        </div>
      `;
      return modal;
    }

    // Function to clear error messages
    function clearErrorMessages() {
      $('.invalid-feedback').remove();
    }

    // Function to disable the login form
    function disableLoginForm() {
      $('#login-form :input').prop('disabled', true);
    }

    // Function to enable the login form
    function enableLoginForm() {
      $('#login-form :input').prop('disabled', false);
    }

    // Function to disable the login button
    function disableLoginButton() {
      $('#login_button').prop('disabled', true);
    }

    // Function to enable the login button
    function enableLoginButton() {
      $('#login_button').prop('disabled', false);
    }

    // Function to check login button status
    function checkLoginButtonStatus() {
      axios.get("{% url 'users:check_login_button_status' %}")
        .then(function(response) {
          if (response.data.disable_login_button) {
            disableLoginForm(); // Disable the entire login form
          } else {
            enableLoginForm(); // Enable the login form
          }
        })
        .catch(function(error) {
          console.error(error);
        });
    }

    // Call the function to check login button status on page load
    checkLoginButtonStatus();

    // Event handler for form submission
    $('#login-form').submit(function(event) {
      event.preventDefault();

      // Check if the form is disabled
      if ($('#login-form :input:disabled').length > 0) {
        return; // Do nothing if the form is disabled
      }

      var formData = new FormData(this);
      var jsonFormData = {};
      for (var [key, value] of formData.entries()) {
        jsonFormData[key] = value;
      }

      // Show processing modal
      var processingModal = createModal('Processing', 'Logging You in...');
      $('body').append(processingModal);

      // Clear any existing error messages when the login button is pressed
      clearErrorMessages();

      axios.post("{% url 'users:login' %}", JSON.stringify(jsonFormData), {
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        }
      })
        .then(function(response) {
          // Remove processing modal
          $(processingModal).remove();

          if (response.data.success) {
            window.location.href = response.data.redirect_url;
          } else {
            // Clear any existing error messages
            clearErrorMessages();

            // Add error message to form fields with errors
            for (const field in response.data.errors) {
              if (field === '__all__') {
                $('#login-form').prepend('<div class="invalid-feedback text-red-600 mb-2">' + response.data.errors[field] + '</div>');
              } else {
                var errorField = $('#id_' + field);
                errorField.addClass('border-red-600');
                errorField.parent().append('<div class="invalid-feedback text-red-600">' + response.data.errors[field][0] + '</div>');
              }
            }

            // Check if the server returned a flag to disable the login button
            if (response.data.disable_login_button) {
              disableLoginButton();
            }
          }
        })
        .catch(function(error) {
          console.error(error);
          $(processingModal).remove(); // Remove processing modal on error
        });
    });
  });
</script>





{% endblock content %}
